<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('查看商业任务明细信息')" />
    <th:block th:include="include :: bootstrap-editable-css" />
    <th:block th:include="include :: bootstrap-fileinput-css" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-task-detail-query" th:object="${salesmanTask}">
            <h4 class="form-header h4">订单信息</h4>
            <div class="row">
                <div class="col-sm-12">
                    <div class="col-sm-12 select-table table-striped">
                        <table id="bootstrap-table"></table>
                    </div>
                </div>
            </div>
            <br/>
            <h4 class="form-header h4 mt20">任务信息</h4>
            <input name="id" th:field="*{id}" type="hidden">
            <div class="form-group">
                <label class="col-sm-2 control-label" >任务编号：</label><label class="col-sm-2 mt5" th:text="${salesmanTask.id}"></label>
                <label class="col-sm-2 control-label" >任务状态：</label><label class="col-sm-2 mt5" th:text="${@dict.getLabel('sys_order_status', salesmanTask.orderStatus)}"></label>
                <label class="col-sm-2 control-label" >订单数量：</label><label class="col-sm-2 mt5" th:text="${orderNumber}"></label>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label" >集团分配时间：</label><label class="col-sm-2 mt5" th:text="${#dates.format(salesmanTask.groupAllocateTime, 'yyyy-MM-dd HH:mm:ss')}"></label>
                <label class="col-sm-2 control-label" >业务组长分配时间：</label><label class="col-sm-2 mt5" th:text="${#dates.format(salesmanTask.allocateTime, 'yyyy-MM-dd HH:mm:ss')}"></label>
                <label class="col-sm-2 control-label" >完成时间：</label><label class="col-sm-2 mt5" th:text="${#dates.format(salesmanTask.completionTime, 'yyyy-MM-dd HH:mm:ss')}"></label>
            </div>
            <h4 class="form-header h4">任务资料</h4>
            <div class="form-group">
                <label class="col-sm-2 control-label">拍摄照片：</label>
                <div class="col-sm-9">
                    <div id="viewer" class="row">
                        <div class="col-sm-3 col-md-3" th:if="${not #strings.isEmpty(salesmanTask.feedbackPictureUrl1)}">
                            <a href="javascript:void(0)" class="thumbnail">
                                <img th:src="${salesmanTask.feedbackPictureUrl1}"  alt="缩略图">
                            </a>
                        </div>
                        <div class="col-sm-3 col-md-3" th:if="${not #strings.isEmpty(salesmanTask.feedbackPictureUrl2)}">
                            <a href="javascript:void(0)" class="thumbnail">
                                <img th:src="${salesmanTask.feedbackPictureUrl2}"  alt="缩略图">
                            </a>
                        </div>
                        <div class="col-sm-3 col-md-3">
                            <a href="javascript:void(0)" class="thumbnail" th:if="${not #strings.isEmpty(salesmanTask.feedbackPictureUrl3)}">
                                <img th:src="${salesmanTask.feedbackPictureUrl3}"  alt="缩略图">
                            </a>
                        </div>
                        <div class="col-sm-3 col-md-3">
                            <a href="javascript:void(0)" class="thumbnail" th:if="${not #strings.isEmpty(salesmanTask.feedbackPictureUrl4)}">
                                <img th:src="${salesmanTask.feedbackPictureUrl4}"  alt="缩略图">
                            </a>
                        </div>
                        <div class="col-sm-3 col-md-3">
                            <a href="javascript:void(0)" class="thumbnail" th:if="${not #strings.isEmpty(salesmanTask.feedbackPictureUrl5)}">
                                <img th:src="${salesmanTask.feedbackPictureUrl5}"  alt="缩略图">
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">任务备注：</label>
                <div class="col-sm-9">
                    <textarea name="remark" th:text="${salesmanTask.remark}" class="form-control" rows="3" readonly="ture"></textarea>
                </div>
            </div>
        </form>
        <div class="modal inmodal" id="myModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content animated bounceInRight">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
                        </button>
                        <h4 class="modal-title">提交订单</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <input id="orderId" name="orderId" type="text" hidden>
                            <input id="platformNickname" name="platformNickname" type="text" hidden>
                            <input id="img" name="img" type="text" hidden>
                            <label class="col-sm-3 control-label"><span style="color:red">*</span>拍摄照片：</label>
                            <div class="col-sm-9" >
                                <div class="file-loading">
                                    <input id="fileinput" name="fileinput" type="file" multiple accept=".jpg,.png">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <label class="col-sm-3 control-label">备注：</label>
                            <div class="col-sm-9">
                                <textarea id="promotersUnitPriceRemark" name="promotersUnitPriceRemark" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="commitOrder()">确定</button>
                        <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-table-editable-js" />
    <th:block th:include="include :: bootstrap-fileinput-js" />
    <script th:inline="javascript">
        var orderStatusDatas = [[${@dict.getType('sys_order_status')}]];

        var image = new Viewer(document.getElementById('viewer'),{
            fullscreen:false
        });

        $(function() {

            $("#fileinput").fileinput({
                'theme': 'explorer-fas',
                'uploadUrl': "/groupcompany/task/upload/insert",
                overwriteInitial: false,
                height: 100,
                initialPreviewAsData: true,
                uploadAsync: false,
                allowedFileExtensions: ['jpg', 'png'],
                enctype: 'multipart/form-data',
                maxFileCount: 1,
                showUpload: false,
                showRemove: false,
                showPreview: false,
                dropZoneEnabled: false,
                validateInitialCount:true,
                msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
            }).on('filepreupload', function(event, data, previewId, index) {     //上传中
                var form = data.form, files = data.files, extra = data.extra,
                    response = data.response, reader = data.reader;
                console.log('文件正在上传');
            }).on("fileuploaded", function (event, data, previewId, index) {    //一个文件上传成功
                console.log('文件上传成功！'+data.response.id);
            }).on('fileerror', function(event, data, msg) {  //一个文件上传失败
                console.log('文件上传失败！'+data.id);
            }).on('filebatchuploadsuccess', function(event,data,previewId,index) {//同步上传回调
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
                parent.layer.alert(data.response.msg);
            });

            var options = {
                data: [[${salesmanTaskDetail}]],
                pagination: false,
                showSearch: false,
                showRefresh: false,
                showToggle: false,
                showColumns: false,
                sidePagination: "client",
                onEditableSave: onEditableSave,
                columns: [
                {
                    field: 'index',
                    align: 'center',
                    title: "序号",
                    formatter: function (value, row, index) {
                    	var columnIndex = $.common.sprintf("<input type='hidden' name='index' value='%s'>", $.table.serialNumber(index));
                    	return columnIndex + $.table.serialNumber(index);
                    }
                },
                {
                    field: 'taskNo',
                    align: 'center',
                    title: '任务编码'
				},
                {
                    field: 'orderDate',
                    align: 'center',
                    title: '订单日期'
				},
                {
                    field: 'shopName',
                    align: 'center',
                    title: '店铺名'
                },
                {
                    field: 'pictureUrl',
                    align: 'center',
                    title: '商品主图',
                    formatter: function(value, row, index) {
                        return $.table.imageView(row.pictureUrl);
                    }
				},
                {
                    field: 'keyword',
                    align: 'center',
                    title: '关键词'
                },
                {
                    field: 'unitPrice',
                    align: 'center',
                    title: '单价/元'
				},
                {
                    field: 'unitPriceRemark',
                    align: 'center',
                    title: '单价备注'
                },
                {
                    field: 'specialRemarks',
                    align: 'center',
                    title: '特殊备注'
                },
                {
                    field: 'platformNickname',
                    align: 'center',
                    title: '买家昵称',
                    editable: true,
                    formatter: function(value, row, index) {
                        if(row.platformNickname === null){
                            return "请点击编辑";
                        }
                        return row.platformNickname;
                    }
                },
                {
                    field: 'promotersModifyUnitPrice',
                    align: 'center',
                    title: '实际单价/元'
                },
                {
                    field: 'salesmanCommitUrl',
                    align: 'center',
                    title: '买家拍照',
                    formatter: function(value, row, index) {
                        return $.table.imageView(row.salesmanCommitUrl);
                    }
                },
                {
                    field: 'promotersUnitPriceRemark',
                    align: 'center',
                    title: '买家备注',
                },
                {
                    field: 'status',
                    align: 'center',
                    title: '订单状态',
                    formatter: function(value, row, index) {
                        return $.table.selectDictLabel(orderStatusDatas, value);
                    }
                },
                {
                    title: '操作',
                    align: 'center',
                    formatter: function(value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn btn-info btn-xs" href="javascript:void(0)" onclick="commitOrderDialog(\'' + index + "\',\'" + row.salesmanCommitUrl + "\',\'" + row.promotersUnitPriceRemark  + "\',\'" + row.platformNickname + "\',\'" + row.id + '\')"><i class="fa fa-check"></i>提交</a>');
                        return actions.join('');
                    }
                }]
            };
            $.table.init(options);
        });

        function onEditableSave (field, row, oldValue, $el) {
            $.operate.submit("/salesman/todaytask/detailEdit","post","json",row);
        }

        function commitOrderDialog(index,salesmanCommitUrl,promotersUnitPriceRemark,platformNickname,id) {
            $('#img').val(salesmanCommitUrl);
            $("#promotersUnitPriceRemark").val(promotersUnitPriceRemark);
            $("#platformNickname").val(platformNickname);
            $("#orderId").val(id);
            var trHtml = $("#form-task-detail-query").find("tr[data-index=" + index + "]");
            $("#myModal").css({'margin-top': trHtml.offset().top});
            $('#myModal').modal('show');
            $('.modal-open').find('.modal-backdrop').remove();
        }

        function commitOrder() {
            console.log("commitOrder");
            var img = $('#img').val();
            var promotersUnitPriceRemark = $("#promotersUnitPriceRemark").val();
            var platformNickname = $("#platformNickname").val();
            var id = $("#orderId").val()
            $.operate.submit("/salesman/todaytask/commitOrder","post","json", {img: img,promotersUnitPriceRemark:promotersUnitPriceRemark,platformNickname:platformNickname,id:id});
        }
    </script>
</body>
</html>